{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nvar _jsxFileName = \"/home/ruitai/alpaca/frontend/src/Components/main.js\";\nimport { Component } from \"react\";\nimport Draggable from 'react-draggable';\nimport Control from './control';\nimport API from './apiHandler';\nimport Stream from \"./stream\";\nimport List from './list';\nimport BumpStrat from './strats/bump';\nimport config from './config.json';\n\nclass Main extends Component {\n  constructor(props) {\n    super(props); //Values that get passed to the component\n\n    this.tickerChange = this.tickerChange.bind(this);\n    this.idChange = this.idChange.bind(this);\n    this.skChange = this.skChange.bind(this);\n    this.streamChange = this.streamChange.bind(this);\n    this.p1Change = this.p1Change.bind(this);\n    this.p2Change = this.p2Change.bind(this);\n    this.pairSwap = this.pairSwap.bind(this);\n    this.priceListener = this.priceListener.bind(this);\n    this.tradeStatusListener = this.tradeStatusListener.bind(this);\n    this.apiPositionListener = this.apiPositionListener.bind(this);\n    this.connect = this.connect.bind(this);\n    this.updatePositions = this.updatePositions.bind(this);\n    this.storeConfig = this.storeConfig.bind(this);\n    this.testClick = this.testClick.bind(this);\n    this.logPos = this.logPos.bind(this);\n    this.clearOrders = this.clearOrders.bind(this); //this.subscribe = this.subscribe.bind(this);\n    //this.unsubscribe = this.unsubscribe.bind(this);\n    //this.initPositions = this.initPositions.bind(this);\n    //this.get_price = this.get_price.bind(this);\n\n    this.positions = {}; // Symbol: [qty, price]\n\n    this.state = {\n      key_id: 'PKE06IXOHYSCN0DKRU3M',\n      //key_id: 'bvqgf2n48v6qg460kck0',\n      secret_key: '1Hv5IIH4niKxwe6uvMSHzVyslejRSwhoiamYCSLQ',\n      positions: null,\n      //array of [Ticker, qty, avg price] arrays\n      streamData: null,\n      //Data from the polygon stream\n      stream: 'stocks',\n      //stream: 'forex',\n      ticker: 'TSLA',\n      // Ticker is the active window ticker symbol\n      p1: \"USD\",\n      p2: \"CAD\",\n      connected: false,\n      test: true\n    };\n  } //#region Onchange Functions (Called from Control Panel)\n  //TODO: May need to update the websocket stream & also the api handler\n  //NOTE: Using this.state.[whatever] after setState doesn't seem to update it until the next iteration;\n  //Need to directly use e.target.value\n\n\n  tickerChange(e) {\n    this.setState({\n      ticker: e.target.value\n    });\n  }\n\n  idChange(e) {\n    this.setState({\n      key_id: e.target.value\n    });\n  }\n\n  skChange(e) {\n    this.setState({\n      secret_key: e.target.value\n    });\n  }\n\n  streamChange(e) {\n    //TODO -> What should the behavior here be wrt to the currently active connections?\n    this.setState({\n      stream: e.target.value\n    }); //this.disconnect()\n    //url state is updated in connect()\n  } //Currency Pair Related Functions\n\n\n  p1Change(e) {\n    this.setState({\n      p1: e.target.value\n    });\n  }\n\n  p2Change(e) {\n    this.setState({\n      p2: e.target.value\n    });\n  }\n\n  pairSwap() {\n    let p1Now = this.state.p1;\n    let p2Now = this.state.p2;\n    this.setState({\n      p1: p2Now\n    });\n    this.setState({\n      p2: p1Now\n    });\n  } //#endregion\n\n\n  priceListener(msg) {\n    //Polygon websocket callback; parses incoming data and updates state\n    //console.log(msg)\n    let data = JSON.parse(msg.data);\n\n    if (data[0].message != null) {\n      console.log(`Polygon says ${data[0].message}`); //initialize positions after authentication confirmation\n\n      if (data[0].message === 'authenticated') {\n        //TODO: How to handle the active window?\n        this.ws.subscribe(this.state.ticker); //Get Position List After Websocket Confirm\n        //alert(\"Getting Positions\")\n\n        this.updatePositions();\n      }\n    } else {\n      //Message is null, so we assume we're subscribed, and getting price data\n      //console.log(JSON.stringify(data))\n      //this.setState({streamData: data})\n      //Data from WS comes in Asynchronously, so we update the position dict\n      for (let datum of data) {\n        if (this.positions[datum.sym] === null) {\n          //initialize the entry with null price if doesn't already exist\n          this.positions[datum.sym] = {\n            value: null\n          };\n        } else {\n          this.positions[datum.sym][\"value\"] = datum.p;\n        }\n      } //alert(\"Setting Positions\")\n\n\n      this.setState({\n        positions: this.positions\n      });\n    }\n  }\n\n  tradeStatusListener(msg) {\n    //Alpaca trade updates websocket Listener\n    //https://alpaca.markets/docs/api-documentation/api-v2/streaming/\n    console.log(msg);\n    let data = JSON.parse(msg).data;\n\n    if (data.status != null) {\n      console.log(`Alpaca says ${data.status}`);\n\n      if (data.status === \"authorized\") {\n        //Subscribe to trade status stream\n        this.ws.alpaca.send(JSON.stringify({\n          \"action\": \"listen\",\n          \"data\": {\n            \"streams\": [\"trade_updates\"]\n          }\n        }));\n      }\n    } else if (data.streams != null) {\n      data.streams.forEach(x => {\n        console.log(`Alpaca is listening to ${x}`);\n      });\n    } else {\n      /*\n          Not 100% sure how to handle order updating in an efficient way.\n          RN I'm just keeping a list of pending orders, which get cleared as they are filled,\n          and a single entry for the previous fill order, so that child components can check it for updates\n           Could there maybe be a situation where the child isn't able to process the fill orders before it gets wiped?\n      */\n      //console.log(`Second branch Alpaca says ${msg}`)\n      //console.log(`Event Type: ${data.event} ${data.order.side}`)\n      //console.log(`Symbol: ${data.order.symbol}`)\n      if (data.event === 'new') {\n        console.log(`New order created at ${data.order.limit_price} per share, for ${data.order.qty} shares`);\n        this.positions[data.order.symbol][\"orders\"][data.order.id] = {\n          [data.order.side]: data.order.qty,\n          price: data.order.limit_price,\n          status: \"open\"\n        }; //this.positions[data.order.symbol][\"orders\"].push({[data.order.side]: data.order.qty, price: data.order.limit_price, id: data.order.id})\n      } else if (data.event === \"fill\") {\n        console.log(`${data.order.filled_qty} orders filled at ${data.order.filled_avg_price}`); //update order status with fill price\n\n        this.positions[data.order.symbol][\"orders\"][data.order.id] = {\n          [data.order.side]: data.order.qty,\n          price: data.order.limit_price,\n          fill_price: data.order.filled_avg_price,\n          status: \"closed\"\n        }; //TODO: These two\n      } else if (data.event === \"partial_fill\") {\n        alert(\"Partial Order Fill\");\n        console.log(`${data.order.filled_qty} orders filled at ${data.order.filled_avg_price}`);\n      } else if (data.event === \"canceled\") {\n        console.log(`Order ${data.order.id} was canceled`);\n      } else {\n        //expired\n        //done_for_day\n        //replaced\n        //Or could be some other stuff\n        console.log(data.event);\n      }\n    }\n  }\n\n  apiPositionListener(msg) {\n    //alert(\"API position listener called\")\n    //Get Alpaca positions list\n    for (let position of JSON.parse(msg)) {\n      //Only subscribe to ws streams if not already subscribed\n      if (this.positions[position.symbol] == null) {\n        this.ws.subscribe(position.symbol);\n      } //Price defaults to last day price; will get overwritten by WS stream if live\n      //alert(`Quantity: ${position.qty}`)\n\n\n      this.positions[position.symbol] = {\n        qty: position.qty,\n        cost: position.avg_entry_price,\n        value: position.lastday_price,\n        orders: {}\n      };\n    }\n\n    this.setState({\n      positions: this.positions\n    });\n  } //Get new positions from Alpaca without subscribing (Called after sell/buy orders) \n\n\n  updatePositions() {\n    this.api.get_positions(this.apiPositionListener);\n  }\n\n  storeConfig() {\n    let res = \"data:application/octet-stream,\";\n    res += encodeURIComponent(JSON.stringify(config));\n    window.open(res);\n  }\n\n  connect() {\n    //Creates new connections to API and Stream\n    if (this.state.stream === \"stocks\") {\n      this.positions[`${this.state.ticker}`] = {\n        value: null\n      };\n      this.api = new API(this.state.key_id, this.state.secret_key, 'https://paper-api.alpaca.markets');\n      this.ws = new Stream(this.state.key_id, this.state.secret_key, 'wss://socket.polygon.io/stocks', 'wss://paper-api.alpaca.markets/stream', this.priceListener, this.tradeStatusListener);\n      this.setState({\n        connected: true\n      });\n    } else {\n      alert(\"Forex support coming soon!\");\n      this.setState({\n        stream: \"stocks\"\n      }); //this.ws = new Stream(this.state.key_id, `wss://ws.finnhub.io?token=${this.state.key_id}`, this.priceListener)\n      //this.api = null\n    }\n  }\n\n  disconnect() {//TODO\n    //this.ws.disconnect()\n  }\n\n  testClick() {\n    if (this.state.test) {\n      this.setState({\n        test: false\n      });\n      console.log(\"Set to false\");\n    } else {\n      this.setState({\n        test: true\n      });\n      console.log(\"Set to true\");\n    }\n  }\n\n  logPos() {\n    console.log(JSON.stringify(this.state.positions));\n  }\n\n  clearOrders(symbol, orderID) {\n    if (orderID == null) {\n      this.positions[symbol][\"orders\"] = null;\n    } else {\n      delete this.positions[symbol][\"orders\"][orderID];\n    }\n  }\n\n  render() {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      children: /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"centered\",\n        children: [/*#__PURE__*/_jsxDEV(Control, {\n          key_id: this.state.key_id,\n          secret_key: this.state.secret_key,\n          ticker: this.state.ticker,\n          stream: this.state.stream,\n          p1: this.state.p1,\n          p2: this.state.p2,\n          idChange: this.idChange,\n          skChange: this.skChange,\n          tickerChange: this.tickerChange,\n          streamChange: this.streamChange,\n          p1Change: this.p1Change,\n          p2Change: this.p2Change,\n          pairSwap: this.pairSwap,\n          connect: this.connect,\n          connected: this.state.connected\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 282,\n          columnNumber: 21\n        }, this), this.state.positions != null && /*#__PURE__*/_jsxDEV(BumpStrat, {\n          test: this.state.test,\n          api: this.api,\n          ticker: this.state.ticker,\n          value: this.state.positions[this.state.ticker][\"value\"]\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 286,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"centeredRow\",\n          children: [/*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: this.testClick,\n            children: \"Test\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 291,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n            onClick: this.logPos,\n            children: \"Log Positions\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 293,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 289,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 281,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 275,\n      columnNumber: 13\n    }, this);\n  }\n\n}\n\nexport default Main;","map":{"version":3,"sources":["/home/ruitai/alpaca/frontend/src/Components/main.js"],"names":["Component","Draggable","Control","API","Stream","List","BumpStrat","config","Main","constructor","props","tickerChange","bind","idChange","skChange","streamChange","p1Change","p2Change","pairSwap","priceListener","tradeStatusListener","apiPositionListener","connect","updatePositions","storeConfig","testClick","logPos","clearOrders","positions","state","key_id","secret_key","streamData","stream","ticker","p1","p2","connected","test","e","setState","target","value","p1Now","p2Now","msg","data","JSON","parse","message","console","log","ws","subscribe","datum","sym","p","status","alpaca","send","stringify","streams","forEach","x","event","order","limit_price","qty","symbol","id","side","price","filled_qty","filled_avg_price","fill_price","alert","position","cost","avg_entry_price","lastday_price","orders","api","get_positions","res","encodeURIComponent","window","open","disconnect","orderID","render"],"mappings":"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","sourcesContent":["import {Component} from \"react\";\nimport Draggable from 'react-draggable';\nimport Control from './control';\nimport API from './apiHandler';\nimport Stream from \"./stream\";\n\nimport List from './list';\n\nimport BumpStrat from './strats/bump';\n\nimport config from './config.json'\n\nclass Main extends Component{\n    constructor(props){\n        super(props);\n        //Values that get passed to the component\n\n        this.tickerChange = this.tickerChange.bind(this);\n        this.idChange = this.idChange.bind(this);\n        this.skChange = this.skChange.bind(this);\n        this.streamChange = this.streamChange.bind(this);\n\n        this.p1Change = this.p1Change.bind(this);\n        this.p2Change = this.p2Change.bind(this);\n        this.pairSwap = this.pairSwap.bind(this);\n\n        this.priceListener = this.priceListener.bind(this);\n        this.tradeStatusListener = this.tradeStatusListener.bind(this);\n        this.apiPositionListener = this.apiPositionListener.bind(this);\n        this.connect = this.connect.bind(this);\n        this.updatePositions = this.updatePositions.bind(this);\n\n        this.storeConfig = this.storeConfig.bind(this);\n\n        this.testClick = this.testClick.bind(this);\n        this.logPos = this.logPos.bind(this);\n        this.clearOrders = this.clearOrders.bind(this);\n\n        //this.subscribe = this.subscribe.bind(this);\n        //this.unsubscribe = this.unsubscribe.bind(this);\n\n        //this.initPositions = this.initPositions.bind(this);\n        //this.get_price = this.get_price.bind(this);\n\n        this.positions = {} // Symbol: [qty, price]\n\n        this.state = {\n            key_id: 'PKE06IXOHYSCN0DKRU3M',\n            //key_id: 'bvqgf2n48v6qg460kck0',\n            secret_key: '1Hv5IIH4niKxwe6uvMSHzVyslejRSwhoiamYCSLQ',\n\n            \n            positions: null, //array of [Ticker, qty, avg price] arrays\n            streamData: null, //Data from the polygon stream\n\n            stream: 'stocks',\n            //stream: 'forex',\n            ticker: 'TSLA', // Ticker is the active window ticker symbol\n\n            p1: \"USD\",\n            p2: \"CAD\",\n\n            connected: false,\n\n            test: true,\n        }\n    }\n\n    //#region Onchange Functions (Called from Control Panel)\n    //TODO: May need to update the websocket stream & also the api handler\n    //NOTE: Using this.state.[whatever] after setState doesn't seem to update it until the next iteration;\n    //Need to directly use e.target.value\n    tickerChange(e) {\n        this.setState({ticker: e.target.value})\n    }\n    idChange(e) {\n        this.setState({key_id: e.target.value});\n    }\n    skChange(e) {\n        this.setState({secret_key: e.target.value});\n    }\n\n    streamChange(e){\n        //TODO -> What should the behavior here be wrt to the currently active connections?\n        this.setState({stream: e.target.value})\n        //this.disconnect()\n\n        //url state is updated in connect()\n    }\n\n    //Currency Pair Related Functions\n    p1Change(e){\n        this.setState({p1: e.target.value})\n    }\n\n    p2Change(e){\n        this.setState({p2: e.target.value})\n    }\n\n    pairSwap(){\n        let p1Now = this.state.p1\n        let p2Now = this.state.p2\n        this.setState({p1: p2Now})\n        this.setState({p2: p1Now})\n    }\n    //#endregion\n\n    \n    priceListener(msg){ //Polygon websocket callback; parses incoming data and updates state\n        //console.log(msg)\n        let data = JSON.parse(msg.data)\n        if (data[0].message != null){\n            console.log(`Polygon says ${data[0].message}`)\n            //initialize positions after authentication confirmation\n            if (data[0].message === 'authenticated'){\n                //TODO: How to handle the active window?\n                this.ws.subscribe(this.state.ticker)\n\n                //Get Position List After Websocket Confirm\n                //alert(\"Getting Positions\")\n                this.updatePositions()\n            }\n        }else{//Message is null, so we assume we're subscribed, and getting price data\n            //console.log(JSON.stringify(data))\n            //this.setState({streamData: data})\n\n            //Data from WS comes in Asynchronously, so we update the position dict\n            for (let datum of data){\n                if (this.positions[datum.sym] === null){\n                    //initialize the entry with null price if doesn't already exist\n                    this.positions[datum.sym] = {value: null}\n                }else{\n                    this.positions[datum.sym][\"value\"] = datum.p\n                }\n                \n            }\n            //alert(\"Setting Positions\")\n            this.setState({positions: this.positions})\n        }\n    }\n\n    tradeStatusListener(msg){ //Alpaca trade updates websocket Listener\n        //https://alpaca.markets/docs/api-documentation/api-v2/streaming/\n\n        console.log(msg)\n        let data = JSON.parse(msg).data\n        if(data.status != null){\n            console.log(`Alpaca says ${data.status}`)\n            if(data.status === \"authorized\"){\n                //Subscribe to trade status stream\n                this.ws.alpaca.send(JSON.stringify({\"action\":\"listen\",\"data\":{\"streams\":[\"trade_updates\"]}}))\n            }\n        }else if(data.streams != null){\n            data.streams.forEach(x => {console.log(`Alpaca is listening to ${x}`)})\n        }else{\n\n            /*\n                Not 100% sure how to handle order updating in an efficient way.\n                RN I'm just keeping a list of pending orders, which get cleared as they are filled,\n                and a single entry for the previous fill order, so that child components can check it for updates\n\n                Could there maybe be a situation where the child isn't able to process the fill orders before it gets wiped?\n            */\n\n\n            //console.log(`Second branch Alpaca says ${msg}`)\n            //console.log(`Event Type: ${data.event} ${data.order.side}`)\n            //console.log(`Symbol: ${data.order.symbol}`)\n            \n            if(data.event === 'new'){\n                console.log(`New order created at ${data.order.limit_price} per share, for ${data.order.qty} shares`)\n                this.positions[data.order.symbol][\"orders\"][data.order.id] = {[data.order.side]: data.order.qty, price: data.order.limit_price, status: \"open\"}\n                //this.positions[data.order.symbol][\"orders\"].push({[data.order.side]: data.order.qty, price: data.order.limit_price, id: data.order.id})\n            }else if (data.event === \"fill\"){\n                console.log(`${data.order.filled_qty} orders filled at ${data.order.filled_avg_price}`)\n                //update order status with fill price\n                this.positions[data.order.symbol][\"orders\"][data.order.id] = {[data.order.side]: data.order.qty, price: data.order.limit_price, fill_price:data.order.filled_avg_price, status: \"closed\"}\n            \n            //TODO: These two\n            }else if(data.event === \"partial_fill\"){\n                alert(\"Partial Order Fill\")\n                console.log(`${data.order.filled_qty} orders filled at ${data.order.filled_avg_price}`)\n            }else if (data.event === \"canceled\"){\n                console.log(`Order ${data.order.id} was canceled`)\n                \n            }else{\n                //expired\n                //done_for_day\n                //replaced\n                //Or could be some other stuff\n                console.log(data.event)\n            }\n        }\n    }\n\n    \n    apiPositionListener(msg){\n        //alert(\"API position listener called\")\n\n        //Get Alpaca positions list\n        for (let position of JSON.parse(msg)){\n            //Only subscribe to ws streams if not already subscribed\n            if(this.positions[position.symbol] == null){\n                this.ws.subscribe(position.symbol)\n            }\n\n            //Price defaults to last day price; will get overwritten by WS stream if live\n            //alert(`Quantity: ${position.qty}`)\n            this.positions[position.symbol] = {qty: position.qty, cost: position.avg_entry_price, value: position.lastday_price, orders: {}}\n        }\n\n        this.setState({positions: this.positions})\n    }\n\n    //Get new positions from Alpaca without subscribing (Called after sell/buy orders) \n    updatePositions(){\n        this.api.get_positions(this.apiPositionListener)\n    }\n\n    storeConfig(){\n        let res = \"data:application/octet-stream,\"\n        res += encodeURIComponent(JSON.stringify(config))\n        window.open(res);\n    }\n\n\n\n    connect(){\n        //Creates new connections to API and Stream\n        if (this.state.stream === \"stocks\"){\n            this.positions[`${this.state.ticker}`] = {value: null}\n            this.api = new API(this.state.key_id, this.state.secret_key, 'https://paper-api.alpaca.markets')\n            this.ws = new Stream(this.state.key_id, this.state.secret_key, 'wss://socket.polygon.io/stocks', 'wss://paper-api.alpaca.markets/stream', this.priceListener, this.tradeStatusListener)\n            this.setState({connected: true})\n        }else{\n            alert(\"Forex support coming soon!\")\n            this.setState({stream: \"stocks\"})\n            //this.ws = new Stream(this.state.key_id, `wss://ws.finnhub.io?token=${this.state.key_id}`, this.priceListener)\n            //this.api = null\n        }\n    }\n\n    disconnect(){\n        //TODO\n        //this.ws.disconnect()\n\n    }\n\n    testClick(){\n        if (this.state.test){\n            this.setState({test:false})\n            console.log(\"Set to false\")\n        }else{\n            this.setState({test:true})\n            console.log(\"Set to true\")\n        }\n    }\n\n    logPos(){\n        console.log(JSON.stringify(this.state.positions))\n    }\n\n    clearOrders(symbol, orderID){\n        if (orderID == null){\n            this.positions[symbol][\"orders\"]= null\n        }else{\n            delete this.positions[symbol][\"orders\"][orderID]\n        }\n\n    }\n\n\n    render(){\n        return(\n            <div>\n                {/*\n                <List positions={this.state.positions} api={this.api} updatePositions={this.updatePositions}/>\n                <button onClick={this.storeConfig}>Save List</button>\n                */}\n\n                <div className=\"centered\">                \n                    <Control key_id={this.state.key_id} secret_key={this.state.secret_key} ticker={this.state.ticker} stream={this.state.stream} p1={this.state.p1} p2={this.state.p2} idChange={this.idChange} skChange={this.skChange} tickerChange={this.tickerChange} streamChange={this.streamChange} p1Change={this.p1Change} p2Change={this.p2Change} pairSwap={this.pairSwap} connect={this.connect} connected={this.state.connected}/>\n                    \n                    {/*Display Strat box only after price feed is live */}\n                    {this.state.positions != null &&\n                    <BumpStrat test={this.state.test} api={this.api} ticker={this.state.ticker} value={this.state.positions[this.state.ticker][\"value\"]}/>\n                    }\n\n                    <div className=\"centeredRow\">\n                        {/*Test for updating props */}\n                        <button onClick={this.testClick}>Test</button>\n                        {/*Show Positions in Console */}\n                        <button onClick={this.logPos}>Log Positions</button>\n                    </div>\n            </div>\n\n            </div>\n        )\n    }\n}\n\nexport default Main;"]},"metadata":{},"sourceType":"module"}